if(!YUI._mojito){YUI._mojito={_cache:{},_clientY:null,_clientYlog:null}}YUI.add("mojito-client",function(Y,NAME){var PAUSEABLE=["executeAction","doRender","doBroadcast","doListen","doUnlisten"],log,lifecycleEvents,State={PAUSED:"paused",ACTIVE:"active"},globalHookHandler;if(!YUI._mojito._clientY){YUI._mojito._clientY=Y}function privateRender(mp,data,view,viewEngine,cb){var mojitView,renderer;if(!mp._views||!mp._views[view]){cb(new Error('View "'+view+'" not found'));return}data=data||{};data.mojit_assets=data.mojit_assets||mp._assetsRoot;mojitView=mp._views[view];renderer=new Y.mojito.ViewRenderer(mojitView.engine,viewEngine);Y.log('Rendering "'+view+'" in Binder',"debug",NAME);renderer.render(data,mp.type,mojitView["content-path"],{buffer:"",error:function(err){cb(err)},flush:function(data){this.buffer+=data},done:function(data){this.buffer+=data;cb(null,this.buffer)}})}function setNewMojitView(viewData,mp){Y.log("setting new view on mojit "+mp._instanceId,"debug",NAME);var newNode=Y.Node.create(viewData);mp._node.replace(newNode);mp._element=document.getElementById(mp._viewId);mp._node=new Y.Node(mp._element);if(Y.Lang.isFunction(mp._binder.onRefreshView)){mp._binder.onRefreshView(mp._node,mp._element)}}function processChildren(children,binderMap){var name,viewId,found;for(name in children){if(children.hasOwnProperty(name)){for(viewId in binderMap){if(binderMap.hasOwnProperty(viewId)&&!found){if(binderMap[viewId].instanceId===children[name].instanceId){children[name].viewId=viewId;found=true}}}found=false}}return children}function bindNode(binder,node,element){var handles=[];if(Y.Lang.isFunction(binder.bind)){binder.bind(node,element)}if(Y.Lang.isFunction(binder.handleClick)){handles.push(Y.delegate("click",binder.handleClick,node,function(){return true},binder))}Y.log("Attached "+handles.length+" event delegates","debug",NAME);return handles}function unbindNode(binder,handles){var retainBinder=false;if(Y.Lang.isFunction(binder.unbind)){retainBinder=binder.unbind.call(binder)}if(handles){Y.Array.each(handles,function(handle){Y.log("Detaching event handle from binder","debug",NAME);handle.detach()})}return retainBinder}function findParentProxy(mojits,childId){var p;Y.Object.some(mojits,function(mojit){Y.Object.some(mojit.children,function(child){if(child.viewId===childId){p=mojit.proxy;return true}});if(p){return true}});return p}function recordBoundMojit(mojits,parentid,newid,type){if(parentid&&mojits[parentid]){if(!mojits[parentid].children){mojits[parentid].children={}}mojits[parentid].children[newid]={type:type,viewId:newid}}}function MojitoClient(config){this.page={};this.timeLogStack=[];this.yuiConsole=null;this._pauseQueue=[];if(config){if(config.perf){globalHookHandler={};Y.mojito.hooks.enableHookGroup(globalHookHandler,"mojito-perf")}this.init(Y.mojito.util.uncleanse(config))}}lifecycleEvents={};MojitoClient.subscribe=function(evt,cb){if(Y&&YUI._mojito._clientY&&Y._yuid!==YUI._mojito._clientY._yuid){return}if(!lifecycleEvents[evt]){lifecycleEvents[evt]=[]}lifecycleEvents[evt].push(cb)};function fireLifecycle(evt,data){var cbs=lifecycleEvents[evt],c;if(!cbs||!cbs.length){return}for(c=0;c<cbs.length;c+=1){cbs[c](data)}}MojitoClient.prototype={init:function(config){var that=this,appConfig=config.appConfig,forwardConfig={config:config,globalHookHandler:globalHookHandler};fireLifecycle("pre-init",forwardConfig);if(!globalHookHandler){globalHookHandler=forwardConfig.globalHookHandler}Y.mojito.hooks.hook("mojitoClient",globalHookHandler,"start",this);if(appConfig&&appConfig.yui&&appConfig.yui.showConsoleInClient&&!that.yuiConsole){YUI().use("console-filters",function(Y){Y.one("body").addClass("yui3-skin-sam");that.yuiConsole=new Y.Console({plugins:[Y.Plugin.ConsoleFilters],logSource:Y.Global,height:600});that.yuiConsole.render();that.init(config)});return}if(Y.mojito.TunnelClient){this.tunnel=new Y.mojito.TunnelClient(config.appConfig)}this.resourceStore=new Y.mojito.ResourceStore(config);this.dispatcher=Y.mojito.Dispatcher.init(this.resourceStore,this.tunnel);this.context=config.context;this.config=config;this._listeners={};this._mojits={};Y.mojito.hooks.hook("mojitoClient",globalHookHandler,"end",this);this.attachBinders(config.binderMap);Y.Array.each(PAUSEABLE,function(mName){var me=this,originalMethod=me[mName];this[mName]=function(){if(me._state===State.PAUSED){me._pauseQueue.push({fn:originalMethod,args:arguments})}else{originalMethod.apply(me,arguments)}}},this);this._state=State.ACTIVE;fireLifecycle("post-init",{})},attachBinders:function(binderMap,parentId,topLevelMojitViewId){var context=this.context,me=this,newMojitProxies=[],parent,topLevelMojitObj,totalBinders=Y.Object.size(binderMap),bindersComplete=0,onBinderComplete,store=this.resourceStore,eventData={binderMap:binderMap,parentId:parentId,topLevelMojitViewId:topLevelMojitViewId};fireLifecycle("pre-attach-binders",eventData);this.pause();binderMap=eventData.binderMap;parentId=eventData.parentId;topLevelMojitViewId=eventData.topLevelMojitViewId;Y.mojito.hooks.hook("mojitoClientBind",globalHookHandler,"start",this);if(!totalBinders){Y.mojito.hooks.hook("mojitoClientBind",globalHookHandler,"resume",this);me.resume();Y.mojito.hooks.hook("mojitoClientBind",globalHookHandler,"end",this);fireLifecycle("post-attach-binders",{});return}onBinderComplete=function(){bindersComplete+=1;if(bindersComplete<totalBinders){return}Y.Array.each(newMojitProxies,function(item){var proxy=item.proxy,children=item.children;me._mojits[proxy._viewId]={proxy:proxy,children:children}});Y.Array.each(newMojitProxies,function(item){var viewid=item.proxy.getId(),mojit=me._mojits[viewid],proxy=item.proxy;mojit.handles=bindNode(proxy._binder,proxy._node,proxy._element);recordBoundMojit(me._mojits,parentId,viewid,proxy.type)});Y.mojito.hooks.hook("mojitoClientBindComplete",globalHookHandler,"start",this);me.resume();Y.mojito.hooks.hook("mojitoClientBindComplete",globalHookHandler,"end",this);fireLifecycle("post-attach-binders",{})};Y.Object.each(binderMap,function(binderData,viewId){var config,type=binderData.type,base=binderData.base,binderName=binderData.name,instanceId=binderData.instanceId,mojitProxy,binderClass,children,binder,mojitNode,element;if(me._mojits[viewId]){Y.log("Not rebinding binder for "+type+" for DOM node "+viewId,"info",NAME);onBinderComplete();return}if(!binderName){Y.log("No binder for "+type+"."+binderData.action,"info",NAME);onBinderComplete();return}Y.use(binderData.name,function(Y){if(me._mojits[viewId]){Y.log("Not rebinding binder for "+binderData.type+" for DOM node "+viewId,"info",NAME);onBinderComplete();return}config=Y.mojito.util.copy(binderData.config);element=document.getElementById(viewId);if(!element){Y.log('Did not find DOM node "'+viewId+'" for binder "'+binderName+'"',"warn",NAME);onBinderComplete();return}mojitNode=new Y.Node(element);binderClass=Y.mojito.binders[binderName];binder=Y.mojito.util.heir(binderClass);Y.log('Created binder "'+binderName+'" for DOM node "'+viewId+'"',"info",NAME);if(binderData.children){children=processChildren(binderData.children,binderMap)}mojitProxy=new Y.mojito.MojitProxy({action:binderData.action,binder:binder,base:base,node:mojitNode,element:element,viewId:viewId,instanceId:instanceId,client:me,store:store,type:type,config:config,context:context});if(me._state===State.PAUSED){mojitProxy._pause()}newMojitProxies.push({proxy:mojitProxy,children:children});if(Y.Lang.isFunction(binder.init)){binder.init(mojitProxy)}onBinderComplete()})},this)},executeAction:function(command,viewId,cb){var outputHandler;Y.log('Executing "'+(command.instance.base||"@"+command.instance.type)+"/"+command.action+'" on the client.',"mojito",NAME);command.context=this.context;outputHandler=new Y.mojito.OutputHandler(viewId,cb,this);if(Y.mojito.hooks){outputHandler.hook=globalHookHandler}this.dispatcher.dispatch(command,outputHandler)},doRender:function(mp,data,view,cb){var viewEngine=this.config.appConfig.viewEngine;if(!mp._views||!mp._assetsRoot){this.resourceStore.expandInstance({type:mp.type},mp.context,function(err,typeInfo){if(err){cb(new Error("Failed to load mojit information for "+mp.type));return}mp._views=typeInfo.views;mp._assetsRoot=typeInfo.assetsRoot;privateRender(mp,data,view,viewEngine,cb)})}else{privateRender(mp,data,view,viewEngine,cb)}},doBroadcast:function(eventId,source,payload,opts){opts=opts||{};var tgtInstId,tgtViewId,child=opts.target?this._mojits[source].children[opts.target.slot]:null;if(opts&&opts.target){if(opts.target.slot&&child){tgtInstId=child.instanceId;Y.Object.each(this._mojits,function(v,k){if(v.proxy._instanceId===tgtInstId){tgtViewId=k}});if(!tgtViewId){Y.log("No broadcast target found for "+opts.target.slot+":"+tgtInstId,"warn",NAME);return}}else if(opts.target.viewId){tgtViewId=opts.target.viewId}}if(this._listeners[eventId]){Y.Array.each(this._listeners[eventId],function(listener){if(!tgtViewId||tgtViewId===listener.viewId){listener.cb({data:payload,source:source})}})}},doListen:function(eventId,viewId,callback){if(!this._listeners[eventId]){this._listeners[eventId]=[]}this._listeners[eventId].push({viewId:viewId,cb:callback})},doUnlisten:function(viewId,needleEvent){var listeners=this._listeners,eventType;function processListenerArray(arr,id){var i=0;while(i<arr.length){if(arr[i].viewId===id){arr.splice(i,1)}else{i+=1}}return arr}if(needleEvent){processListenerArray(listeners[needleEvent],viewId)}else{for(eventType in listeners){if(listeners.hasOwnProperty(eventType)){processListenerArray(listeners[eventType],viewId)}}}},destroyMojitProxy:function(viewId,retainNode){var mojits=this._mojits,parent,instanceId;if(mojits[viewId]&&mojits[viewId].proxy){instanceId=mojits[viewId].proxy._instanceId;mojits[viewId].proxy._destroy(retainNode);delete mojits[viewId];parent=findParentProxy(mojits,viewId);if(parent&&parent._binder.onChildDestroyed&&Y.Lang.isFunction(parent._binder.onChildDestroyed)){parent._binder.onChildDestroyed({id:viewId})}}},pause:function(){if(this._state===State.PAUSED){Y.log('Cannot "pause" the mojito client because it has'+" already been paused.","warn",NAME);return}this._state=State.PAUSED;Y.Object.each(this._mojits,function(moj){moj.proxy._pause()});Y.log("Mojito Client state: "+this._state+".","info",NAME)},resume:function(){if(this._state!==State.PAUSED){Y.log('Cannot "resume" the mojito client because it was'+" never paused.","warn",NAME);return}this._state=State.ACTIVE;Y.Object.each(this._mojits,function(moj){moj.proxy._resume()});Y.Array.each(this._pauseQueue,function(queuedItem){var fn=queuedItem.fn,args=queuedItem.args;fn.apply(this,args)},this);this._pauseQueue=[];Y.log("Mojito Client state: "+this._state+".","info",NAME)},refreshMojitView:function(mp,opts,cb){var my=this;mp.invoke(mp._action,opts,function(err,data,meta){if(err){if(typeof cb==="function"){cb(new Error(err));return}throw new Error(err)}var idReplacements={},metaBinderViewId,mBinder,freshBinders={},clientMojitViewId,clientMojit,processMojitChildrenForIdReplacements;processMojitChildrenForIdReplacements=function(clientChildren,metaChildren,idRepls){var metaChild,childMojitProxy,metaSubChildren,slot;if(!metaChildren||!clientChildren){return}for(slot in metaChildren){if(metaChildren.hasOwnProperty(slot)){metaChild=metaChildren[slot];if(clientChildren&&clientChildren[slot]){childMojitProxy=clientChildren[slot].proxy}if(childMojitProxy){metaSubChildren=meta.binders[metaChild.viewId].config.children;idRepls[metaChild.viewId]=childMojitProxy.getId();if(metaSubChildren){processMojitChildrenForIdReplacements(my.mojits[childMojitProxy.getId()].children,metaSubChildren,idRepls)}}}}};for(clientMojitViewId in my._mojits){if(my._mojits.hasOwnProperty(clientMojitViewId)){clientMojit=my._mojits[clientMojitViewId];for(metaBinderViewId in meta.binders){if(meta.binders.hasOwnProperty(metaBinderViewId)){mBinder=meta.binders[metaBinderViewId];if(mBinder.instanceId===clientMojit.proxy._instanceId){Y.log("matched instanceId "+mBinder.instanceId,"debug",NAME);idReplacements[metaBinderViewId]=clientMojitViewId;processMojitChildrenForIdReplacements(my._mojits[clientMojit.proxy.getId()].children,mBinder.children,idReplacements)}}}}}Y.Object.each(idReplacements,function(to,from){var regex=new RegExp(from,"g");data=data.replace(regex,to)});setNewMojitView(data,mp);Y.Object.each(meta.children,function(child,slot){var childViewId=idReplacements[child.viewId],childMojit=my._mojits[childViewId],childProxy,childNode,childElement,childBinder;if(!childMojit){freshBinders[child.viewId]=meta.binders[child.viewId];return}childProxy=my._mojits[childViewId].proxy;childNode=mp._node.one("#"+childViewId);childElement=childNode._node;childBinder=childProxy._binder;childProxy._node=childNode;childProxy._element=childElement;if(Y.Lang.isFunction(childBinder.onRefreshView)){childBinder.onRefreshView(childNode,childElement)}else if(Y.Lang.isFunction(childBinder.bind)){childBinder.bind(childNode,childElement)}});my.attachBinders(freshBinders);if(cb){cb(data,meta)}})}};Y.namespace("mojito").Client=MojitoClient},"0.1.0",{requires:["io-base","event-delegate","node-base","querystring-stringify-simple","mojito","mojito-dispatcher","mojito-route-maker","mojito-client-store","mojito-mojit-proxy","mojito-tunnel-client","mojito-output-handler","mojito-util","mojito-hooks"]});

YUI.add("mojito-route-maker",function(Y,NAME){var doCallReplacement,CACHE={routes:{}};function wild(it){if(it.indexOf("{")===0){return it.substring(1,it.length-1)}}function resolveParams(route,params){var tester=[];if(Y.Object.size(route.requires)===0){return route}Y.Object.each(params,function(pval,pname){if(route.requires&&route.requires[pname]){tester.push(pname+"="+pval)}});if(tester.length){tester.sort();if((new RegExp(route.int_match)).test(tester.join("&"))){Y.Object.each(params,function(pval,pname){route.query[pname]=pval});return route}}}function buildRoute(name,route){var i,verbObj,path,matches,build,segment,key;if(!route.name){route.name=name}if(!route.verbs){route.verbs=["GET"]}if(route.verbs.length&&route.path&&route.call){if(!route.params){route.params={}}if(!route.regex){route.regex={}}if(!route.query){route.query={}}verbObj={};for(i in route.verbs){if(route.verbs.hasOwnProperty(i)){verbObj[route.verbs[i].toUpperCase()]=true}}route.verbs=verbObj;path=route.path.split("/");for(segment in path){if(path.hasOwnProperty(segment)){if(path[segment][0]===":"){key=path[segment].substr(1);route.query[key]="";path[segment]=route.regex[key]?"("+route.regex[key]+")":"([^/]+)"}if(path[segment][0]==="*"){path[segment]="(.*)"}}}route.requires={};matches=route.path.match(/:([^\/]+)/g);for(i in matches){if(matches.hasOwnProperty(i)){route.requires[matches[i].substr(1)]="[^&]+"}}for(i in route.regex){if(route.regex.hasOwnProperty(i)){route.requires[i]=route.regex[i]}}if(typeof route.params!=="object"){route.params=Y.QueryString.parse(String(route.params))}build=[];for(i in route.requires){if(route.requires.hasOwnProperty(i)){build.push(i+"="+route.requires[i])}}build.sort();route.ext_match="^"+path.join("/")+"$";route.int_match="^"+build.join("&")+"$"}return route}doCallReplacement=function(route,uri){var uriParts=uri.substr(1).split("/"),pathParts=route.path.substr(1).split("/"),template={},cnt=0;pathParts.forEach(function(pathPart){var key,val,regex;if(pathPart.indexOf(":")===0){key=pathPart.substr(1);val=uriParts[cnt];template[key]=val;regex=new RegExp("{"+key+"}","g");if(regex.test(route.call)){route.call=route.call.replace(regex,template[key])}else{route.params[key]=val}}cnt+=1});return route};function Maker(routes,init){var name;if(init){CACHE.routes={}}for(name in routes){if(routes.hasOwnProperty(name)){if(!CACHE.routes[name]){CACHE.routes[name]=buildRoute(name,routes[name])}}}}Maker.prototype={make:function(query,verb,params){var parts=query.split("?"),call=parts[0],residual={},route,uri,k;params=params||{};verb=verb||"GET";if(parts[1]){params=Y.QueryString.parse(parts[1])}route=this._matchToExternal(call,params,verb,CACHE.routes);if(!route){throw new Error("No route match found for '"+query+"' ("+verb+")")}uri=route.path;for(k in params){if(params.hasOwnProperty(k)){if(route.query&&route.query[k]){uri=uri.replace(":"+k,params[k])}else{residual[k]=params[k]}}}if(!Y.Object.isEmpty(residual)){uri+="?"+Y.QueryString.stringify(residual)}return uri},find:function(uri,verb){var route,match,ret,i,id;verb=verb||"GET";route=this._matchToInternal(uri,verb,CACHE.routes);if(!route){return null}match=Y.mojito.util.copy(route);ret=(new RegExp(route.ext_match)).exec(uri);i=1;for(id in match.query){if(match.query.hasOwnProperty(id)){match.query[id]=ret[i];i+=1}}for(i in match.params){if(match.params.hasOwnProperty(i)&&!match.query[i]){match.query[i]=match.params[i]}}return match},getComputedRoutes:function(){return Y.mojito.util.copy(CACHE.routes)},_matchToInternal:function(uri,verb,routes){var name;if(!verb){verb="GET"}verb=verb.toUpperCase();for(name in routes){if(routes.hasOwnProperty(name)){if((new RegExp(routes[name].ext_match)).test(uri)&&routes[name].verbs&&routes[name].verbs.hasOwnProperty(verb)){return doCallReplacement(Y.mojito.util.copy(routes[name]),uri)}}}return false},_matchToExternal:function(call,params,verb,routes){var match,callParts=call.split("."),callId=callParts[0],callAction=callParts[1];Y.Object.some(routes,function(route){var routeCall,routeId,routeAction,wildId,wildAction;if(call===route.call&&route.verbs[verb]){match=resolveParams(route,params);if(match){return true}}if("*.*"===route.call&&route.verbs[verb]){params.module=callId;params.action=callAction;match=resolveParams(route,params);if(match){return true}}routeCall=route.call.split(".");routeId=routeCall[0];routeAction=routeCall[1];wildId=wild(routeId);if(wildId){params[wildId]=callId}wildAction=wild(routeAction);if(wildAction){params[wildAction]=callAction}if((wildAction||callAction===routeAction)&&(wildId||callId===routeId)&&route.verbs[verb]){match=resolveParams(route,params);if(match){return true}}});return match}};Y.namespace("mojito").RouteMaker=Maker},"0.1.0",{requires:["querystring-stringify-simple","querystring-parse","mojito-util"]});
